name: Auto Issue Status from Branch → PR Merge

on:
  push:
    # 브랜치 생성(push) 이벤트 감지
    branches:
      - '**'
  pull_request:
    types: [closed]

permissions:
  issues: write
  pull-requests: read

jobs:
  branch-created:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Extract branch name
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
      - name: Extract issue number from branch name (ending #<num>)
        id: extract
        run: |
          if [[ "${BRANCH}" =~ \#([0-9]+)$ ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "ISSUE_NUMBER=${ISSUE_NUMBER}" >> $GITHUB_ENV
            echo "Found issue number ${ISSUE_NUMBER} in branch ${BRANCH}"
          else
            echo "No trailing issue number found in branch ${BRANCH}"
            exit 0
          fi
      - name: Mark issue In Progress
        if: env.ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt(process.env.ISSUE_NUMBER);
            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: "🔄 자동 상태 변경: In Progress (브랜치 생성)"
            });
            console.log(`Issue #${issue_number} marked In Progress from branch ${process.env.BRANCH}`);
  pr-merged:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Extract source branch name
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
      - name: Extract issue number from branch name
        id: extract2
        run: |
          if [[ "${BRANCH}" =~ \#([0-9]+)$ ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "ISSUE_NUMBER=${ISSUE_NUMBER}" >> $GITHUB_ENV
            echo "Found issue number ${ISSUE_NUMBER} in branch ${BRANCH}"
          else
            echo "No trailing issue number found in branch ${BRANCH}"
            exit 0
          fi
      - name: Mark issue Done & close
        if: env.ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt(process.env.ISSUE_NUMBER);
            const { owner, repo } = context.repo;
            // 코멘트 추가
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: "✅ 자동 상태 변경: Done (PR 머지됨)"
            });
            // 이슈 닫기
            await github.rest.issues.update({
              owner,
              repo,
              issue_number,
              state: "closed"
            });
            console.log(`Issue #${issue_number} marked Done and closed from branch ${process.env.BRANCH}`);
